#!/bin/bash

if [ $# -ne 1 ];then
	echo "Usage: $0 <compressed_fs>"
	exit 2
fi

FS_FILE=$(realpath $1)
DIR_NAME=${FS_FILE%%.*}
BASE_NAME=${FS_FILE##*/}
BASE_FILE=${BASE_NAME%%.*}
FILE_PATH=$DIR_NAME/$BASE_NAME

echo "Attempting to extract $FS_FILE into $DIR_NAME"
if [ -d "$DIR_NAME" ]; then
	echo "Warning: $DIR_NAME already exists"
	read -p "Overwrite all files ? [y/n]" -n1 
	if [ "$REPLY" == "y" ];then
		echo "Removing all files inside $DIR_NAME"
		rm -rf $DIR_NAME/*
	else
		echo "Exiting"
		exit 2
	fi
else
	echo "Creating $DIR_NAME"
	mkdir -p $DIR_NAME
	if [ $? -ne 0 ]; then
		echo -e "Could not create $DIR_NAME\nExiting"
		exit 2
	fi
fi

echo "Copying $FS_FILE into $FILE_PATH"
cp $FS_FILE $FILE_PATH

OLD_PWD=$PWD
echo "Changing to $DIR_NAME"
cd $DIR_NAME

if [[ $(file -b --mime-type "$BASE_NAME") == 'application/gzip' ]]; then
	echo "$BASE_NAME is compressed using GZIP"
	ext=$(echo $BASE_NAME | awk -F'.' '{print $NF}')
	if [ "$ext" != "gz" ]; then
		echo "Warning: $BASE_NAME does not have .gz extension"
		echo "Renaming $BASE_NAME to $BASE_FILE.gz"
		mv $BASE_NAME $BASE_FILE.gz
		BASE_NAME="$BASE_FILE.gz"
	fi
	echo "Decompressing $BASE_NAME"
	gunzip $BASE_NAME
	if [ $? -ne 0 ]; then
		echo -e "Gunzip failed\nExiting"
		cd $OLD_PWD
		exit 2
	fi
	echo "Finished decompressing"
	CPIO_FILE=$(ls)
	echo -e "Found CPIO file $CPIO_FILE\nExtracting"
	cpio -idm < $CPIO_FILE
	echo -e "Finished extraction of $CPIO_FILE\nRemoving it now"
	rm $CPIO_FILE
elif [[ $(file -b --mime-type "$BASE_NAME") == 'application/octet-stream' ]]; then
	CPIO_FILE=$FILE_PATH
	cpio -idv < $CPIO_FILE
	rm $CPIO_FILE
else
	echo "I don't know how to decompress this file: $BASE_NAME"
	cd $OLD_PWD
	exit 2
fi

echo -e "Done\nExtracted filesystem in $DIR_NAME"
cd $OLD_PWD
