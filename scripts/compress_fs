#!/bin/bash
usage () {
	echo "Usage: $0 [-f <exploit binary>] [-F <exploit source>] [-g] [-h] <fs_dir>"
	echo -e "-f <exploit binary>\t: The path to the compiled exploit binary."
	echo -e "-F <exploit source>\t: The path to the exploit source code that needs to be compiled."
	echo -e "-g\t\t\t: Use this command if the CPIO has to be compressed with GZIP."
	echo -e "<fs_dir>\t\t: The path to the extracted filesystem."
	echo -e "-h\t\t\t: Show this help."
	exit 2
}


if [ $# -lt 1 ]; then
	usage
fi

PAYLOAD=
SRC=
GZIP=
CC=${CC-gcc}
CFLAGS=${CFLAGS-}

while getopts "f:F:gh" flag; do
	case "$flag" in 
		f)
			PAYLOAD=$OPTARG;;
		F)
			SRC=$OPTARG;;
		g)
			GZIP=1;;
		h)
			usage;;

	esac
done

if [ -n "$PAYLOAD" -a -n "$SRC" ]; then
	echo -e "Error: Cannot use both -f and -F options together\nExiting"
	exit 2
elif [ -n "$SRC" ]; then
	echo -e "Compiling exploit script $SRC\nUsing CC=$CC CFLAGS=$CFLAGS -static"
	echo "Compiling $SRC to payload"
	$CC $CFLAGS -static $SRC -o payload
	if [ $? -ne 0 ]; then
		echo -e "Compiling $SRC failed\nExiting"
		exit 2
	fi
	PAYLOAD=$PWD/payload
fi

shift $(($OPTIND-1))

FS_DIR=$(realpath $1)
BASE_NAME=$(basename $FS_DIR)

if [ -f "$PAYLOAD" ]; then
	echo "Copying $PAYLOAD into $FS_DIR"
	cp $PAYLOAD $FS_DIR/
	if [ $? -ne 0 ];then
		echo -e "Could not copy\nExiting"
		exit 2
	fi
fi

OLD_PWD=$PWD

echo "Changing directory to $FS_DIR"
cd $FS_DIR

if [ "$GZIP" -eq 1 ]; then

	echo "Compressing $FS_DIR into $BASE_NAME.cpio.gz"
	find . -print0 \
		| cpio --null -ov --format=newc \
		| gzip -9 > $BASE_NAME.cpio.gz
	OUTFILE=$BASE_NAME.cpio.gz
else
	echo "Compressing $FS_DIR into $BASE_NAME.cpio"
	find . -print0 | cpio --null -ov --format=newc > $BASE_NAME.cpio
	OUTFILE=$BASE_NAME.cpio
fi

echo "Done compressing"

mv $OUTFILE $OLD_PWD/
echo "Leaving $OUTFILE in $OLD_PWD"
cd $OLD_PWD
